
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Data - AdminHub</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(to bottom right, #1e1e2f, #2b2b3f);
        color: #fff;
        padding: 40px 20px;
        min-height: 100vh;
      }

      .header-section {
        text-align: center;
        margin-bottom: 40px;
      }

      .header-section h1 {
        font-size: 2.5em;
        margin-bottom: 20px;
        background: linear-gradient(to right, #00c6ff, #0072ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        margin-bottom: 30px;
      }

      .action-btn {
        background: linear-gradient(to right, #0072ff, #00c6ff);
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 16px;
        font-weight: 600;
        padding: 12px 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 114, 255, 0.3);
      }

      .action-btn.fetch-btn {
        background: linear-gradient(to right, #27ae60, #2ecc71);
      }

      .action-btn.export-btn {
        background: linear-gradient(to right, #f39c12, #e67e22);
      }

      /* Fetch Employee Section */
      .fetch-section {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
      }

      .fetch-input-group {
        display: flex;
        gap: 15px;
        align-items: end;
        flex-wrap: wrap;
      }

      .fetch-input-group input {
        flex: 1;
        min-width: 200px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 12px 16px;
        color: white;
        font-size: 16px;
      }

      .fetch-input-group input:focus {
        outline: none;
        border-color: rgba(0, 198, 255, 0.5);
        box-shadow: 0 0 0 2px rgba(0, 198, 255, 0.2);
      }

      /* Modal Styles */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
      }

      .modal-content {
        backdrop-filter: blur(10px);
        background-color: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        border-style: solid;
        border-width: 0.8px;
        box-shadow: rgba(0, 0, 0, 0.3) 0px 20px 40px 0px;
        padding: 40px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        margin: 20px;
      }

      .modal-close {
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-size: 24px;
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-close:hover {
        color: rgb(255, 255, 255);
      }

      .modal-title {
        font-size: 28.8px;
        font-weight: 700;
        margin-bottom: 20px;
        text-align: center;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-group label {
        font-size: 14.4px;
        font-weight: 500;
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.9);
      }

      .form-group input,
      .form-group select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 12px 16px;
        color: white;
        font-family: Arial;
        font-weight: 400;
        transition: all 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: rgba(0, 198, 255, 0.5);
        box-shadow: 0 0 0 2px rgba(0, 198, 255, 0.2);
        background: rgba(255, 255, 255, 0.15);
      }

      .form-group select option {
        background: #2b2b3f;
        color: white;
      }

      .btn-submit {
        display: inline-block;
        background: linear-gradient(
          to right,
          rgb(0, 114, 255),
          rgb(0, 198, 255)
        );
        border-radius: 12px;
        border: none;
        font-family: Arial;
        font-weight: 600;
        margin-top: 20px;
        padding: 15px 30px;
        transition: all 0.3s ease;
        width: 100%;
        color: white;
        font-size: 16px;
        cursor: pointer;
      }

      .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 114, 255, 0.3);
      }

      .btn-submit:disabled {
        cursor: not-allowed;
        opacity: 0.7;
      }

      .success-message {
        display: none;
        color: rgb(0, 255, 174);
        font-weight: 700;
        margin-top: 15px;
        text-align: center;
        padding: 10px;
        border-radius: 8px;
        background: rgba(39, 174, 96, 0.1);
        border: 1px solid rgba(39, 174, 96, 0.3);
      }

      .step-indicator {
        display: none;
        margin-top: 10px;
        padding: 8px;
        border-radius: 6px;
        background: rgba(0, 114, 255, 0.1);
        border: 1px solid rgba(0, 114, 255, 0.3);
        color: #00c6ff;
        font-size: 14px;
        text-align: center;
      }

      #firebaseStatus,
      #editFirebaseStatus {
        padding: 8px 12px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        text-align: center;
        margin-bottom: 15px;
        font-size: 14px;
      }

      /* Employee Display */
      .employee-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 30px;
      }

      .profile-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 30px;
        width: 350px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        animation: fadeIn 1.2s ease-in-out;
        text-align: left;
        position: relative;
      }

      .profile-card:hover {
        transform: translateY(-5px);
        transition: all 0.3s ease;
      }

      .profile-header {
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 15px;
      }

      .profile-header h3 {
        color: #00c6ff;
        margin-bottom: 5px;
        font-size: 1.4em;
      }

      .emp-id {
        background: linear-gradient(to right, #0072ff, #00c6ff);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .info-grid {
        display: grid;
        gap: 8px;
        font-size: 14px;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .info-label {
        color: #aaa;
        font-weight: 500;
        min-width: 120px;
      }

      .info-value {
        color: white;
        font-weight: 400;
        text-align: right;
        flex: 1;
      }

      .employee-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .btn-edit,
      .btn-delete {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        flex: 1;
      }

      .btn-edit {
        background: linear-gradient(to right, #0072ff, #00c6ff);
        color: white;
      }

      .btn-delete {
        background: linear-gradient(to right, #ff4757, #ff3838);
        color: white;
      }

      .btn-edit:hover,
      .btn-delete:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .loading {
        text-align: center;
        color: #aaa;
        font-size: 1.2em;
        margin: 50px 0;
      }

      /* Employee Details View */
      .employee-details {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 25px;
        margin-top: 20px;
        backdrop-filter: blur(10px);
      }

      .details-header {
        text-align: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(0, 198, 255, 0.3);
      }

      .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .detail-section {
        background: rgba(255, 255, 255, 0.03);
        padding: 20px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .section-title {
        color: #00c6ff;
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 16px;
        border-bottom: 1px solid rgba(0, 198, 255, 0.2);
        padding-bottom: 5px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body>
    <div class="header-section">
      <h1>Employee Management System</h1>

      <div class="action-buttons">
        <button class="action-btn" onclick="showAddEmployeeModal()">
          <i class="bx bx-plus"></i> Add New Employee
        </button>
        <button class="action-btn fetch-btn" onclick="toggleFetchSection()">
          <i class="bx bx-search"></i> Fetch Employee Data
        </button>
        <button class="action-btn export-btn" onclick="exportToExcel()">
          <i class="bx bx-download"></i> Export to Excel
        </button>
        <button class="action-btn" onclick="syncWithFirebase()">
          <i class="bx bx-refresh"></i> Sync with Firebase
        </button>
      </div>
    </div>

    <!-- Fetch Employee Section -->
    <div id="fetchSection" class="fetch-section" style="display: none">
      <h3 style="margin-bottom: 20px; color: #00c6ff">
        <i class="bx bx-search"></i> Fetch Employee by ID
      </h3>
      <div class="fetch-input-group">
        <div style="flex: 1">
          <label style="display: block; margin-bottom: 5px; color: #aaa"
            >Employee ID</label
          >
          <input
            type="text"
            id="fetchEmpId"
            placeholder="Enter Employee ID (e.g., EMP001)"
            style="width: 100%"
          />
        </div>
        <button
          class="action-btn"
          onclick="fetchEmployeeById()"
          style="height: fit-content"
        >
          <i class="bx bx-search"></i> Fetch Data
        </button>
      </div>
      <div id="fetchResult" style="margin-top: 20px"></div>
    </div>

    <div id="loadingMessage" class="loading">
      Loading employees from Firebase...
    </div>
    <div id="teamContainer" class="employee-grid"></div>

    <!-- Edit Employee Modal -->
    <div id="editEmployeeModal" class="modal-overlay">
      <div class="modal-content">
        <button class="modal-close" onclick="hideEditEmployeeModal()">
          &times;
        </button>
        <h2 class="modal-title">Edit Employee</h2>

        <div id="editFirebaseStatus">
          <span
            id="editFirebaseIndicator"
            style="
              display: inline-block;
              width: 10px;
              height: 10px;
              border-radius: 50%;
              background: #ff4757;
              margin-right: 8px;
            "
          ></span>
          <span id="editFirebaseStatusText">Connecting to Firebase...</span>
        </div>

        <form id="editEmployeeForm" onsubmit="handleEditEmployee(event)">
          <div class="form-grid">
            <!-- Personal Information -->
            <div class="form-group">
              <label for="editEmpId">Employee ID *</label>
              <input
                type="text"
                id="editEmpId"
                name="empId"
                required
                readonly
                style="background: rgba(255, 255, 255, 0.05)"
              />
            </div>
            <div class="form-group">
              <label for="editEmpName">Full Name *</label>
              <input type="text" id="editEmpName" name="empName" required />
            </div>
            <div class="form-group">
              <label for="editEmpContact">Contact Number *</label>
              <input
                type="tel"
                id="editEmpContact"
                name="empContact"
                required
              />
            </div>
            <div class="form-group">
              <label for="editEmpEmail">Email *</label>
              <input type="email" id="editEmpEmail" name="empEmail" required />
            </div>
            <div class="form-group">
              <label for="editEmpMaritalStatus">Marital Status</label>
              <select id="editEmpMaritalStatus" name="empMaritalStatus">
                <option value="">Select Status</option>
                <option value="Single">Single</option>
                <option value="Married">Married</option>
                <option value="Divorced">Divorced</option>
                <option value="Widowed">Widowed</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editEmpEmergencyContact">Emergency Contact</label>
              <input
                type="tel"
                id="editEmpEmergencyContact"
                name="empEmergencyContact"
              />
            </div>

            <!-- Address -->
            <div class="form-group full-width">
              <label for="editEmpAddress">Address</label>
              <input type="text" id="editEmpAddress" name="empAddress" />
            </div>

            <!-- Government IDs -->
            <div class="form-group">
              <label for="editEmpPan">PAN (10 Digits Alpha Numeric)</label>
              <input
                type="text"
                id="editEmpPan"
                name="empPan"
                maxlength="10"
                style="text-transform: uppercase"
              />
            </div>
            <div class="form-group">
              <label for="editEmpAadhar">Aadhar (12 Digit Number)</label>
              <input
                type="text"
                id="editEmpAadhar"
                name="empAadhar"
                maxlength="12"
              />
            </div>
            <div class="form-group">
              <label for="editEmpUan">UAN (12 Digit Number)</label>
              <input type="text" id="editEmpUan" name="empUan" maxlength="12" />
            </div>

            <!-- Employment Details -->
            <div class="form-group">
              <label for="editEmpJoinDate">Date of Joining *</label>
              <input
                type="date"
                id="editEmpJoinDate"
                name="empJoinDate"
                required
              />
            </div>
            <div class="form-group">
              <label for="editEmpExitDate">Date of Exit</label>
              <input type="date" id="editEmpExitDate" name="empExitDate" />
            </div>

            <!-- Salary Details -->
            <div class="form-group">
              <label for="editEmpBasicSalary">Basic Salary *</label>
              <input
                type="number"
                id="editEmpBasicSalary"
                name="empBasicSalary"
                step="0.01"
                required
              />
            </div>
            <div class="form-group">
              <label for="editEmpDearnessAllowance">Dearness Allowance</label>
              <input
                type="number"
                id="editEmpDearnessAllowance"
                name="empDearnessAllowance"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="editEmpPersonalAllowance">Personal Allowance</label>
              <input
                type="number"
                id="editEmpPersonalAllowance"
                name="empPersonalAllowance"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="editEmpConveyanceAllowance"
                >Conveyance Allowance</label
              >
              <input
                type="number"
                id="editEmpConveyanceAllowance"
                name="empConveyanceAllowance"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="editEmpProfessionalAllowance"
                >Professional Allowance</label
              >
              <input
                type="number"
                id="editEmpProfessionalAllowance"
                name="empProfessionalAllowance"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="editEmpBonus">Bonus</label>
              <input
                type="number"
                id="editEmpBonus"
                name="empBonus"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="editEmpGrossSalary"
                >Gross Salary (Auto-calculated)</label
              >
              <input
                type="number"
                id="editEmpGrossSalary"
                name="empGrossSalary"
                readonly
                style="background: rgba(255, 255, 255, 0.05)"
              />
            </div>
          </div>

          <button type="submit" class="btn-submit">
            Update Employee in Firebase
          </button>

          <div id="editStepIndicator" class="step-indicator">
            Step 1: Validating data...
          </div>

          <div id="editSuccessMessage" class="success-message">
            Employee updated successfully!
          </div>
        </form>
      </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="modal-overlay">
      <div class="modal-content">
        <button class="modal-close" onclick="hideAddEmployeeModal()">
          &times;
        </button>
        <h2 class="modal-title">Add New Employee</h2>

        <div id="firebaseStatus">
          <span
            id="firebaseIndicator"
            style="
              display: inline-block;
              width: 10px;
              height: 10px;
              border-radius: 50%;
              background: #ff4757;
              margin-right: 8px;
            "
          ></span>
          <span id="firebaseStatusText">Connecting to Firebase...</span>
        </div>

        <form id="addEmployeeForm" onsubmit="handleAddEmployee(event)">
          <div class="form-grid">
            <!-- Personal Information -->
            <div class="form-group">
              <label for="empId">Employee ID *</label>
              <input
                type="text"
                id="empId"
                name="empId"
                placeholder="EMP001"
                required
              />
            </div>
            <div class="form-group">
              <label for="empName">Full Name *</label>
              <input type="text" id="empName" name="empName" required />
            </div>
            <div class="form-group">
              <label for="empContact">Contact Number *</label>
              <input
                type="tel"
                id="empContact"
                name="empContact"
                placeholder="9876543210"
                required
              />
            </div>
            <div class="form-group">
              <label for="empEmail">Email *</label>
              <input type="email" id="empEmail" name="empEmail" required />
            </div>
            <div class="form-group">
              <label for="empMaritalStatus">Marital Status</label>
              <select id="empMaritalStatus" name="empMaritalStatus">
                <option value="">Select Status</option>
                <option value="Single">Single</option>
                <option value="Married">Married</option>
                <option value="Divorced">Divorced</option>
                <option value="Widowed">Widowed</option>
              </select>
            </div>
            <div class="form-group">
              <label for="empEmergencyContact">Emergency Contact</label>
              <input
                type="tel"
                id="empEmergencyContact"
                name="empEmergencyContact"
                placeholder="Emergency contact number"
              />
            </div>

            <!-- Address -->
            <div class="form-group full-width">
              <label for="empAddress">Address</label>
              <input
                type="text"
                id="empAddress"
                name="empAddress"
                placeholder="Complete address"
              />
            </div>

            <!-- Government IDs -->
            <div class="form-group">
              <label for="empPan">PAN (10 Digits Alpha Numeric)</label>
              <input
                type="text"
                id="empPan"
                name="empPan"
                placeholder="ABCDE1234F"
                maxlength="10"
                style="text-transform: uppercase"
              />
            </div>
            <div class="form-group">
              <label for="empAadhar">Aadhar (12 Digit Number)</label>
              <input
                type="text"
                id="empAadhar"
                name="empAadhar"
                placeholder="123456789012"
                maxlength="12"
              />
            </div>
            <div class="form-group">
              <label for="empUan">UAN (12 Digit Number)</label>
              <input
                type="text"
                id="empUan"
                name="empUan"
                placeholder="123456789012"
                maxlength="12"
              />
            </div>

            <!-- Employment Details -->
            <div class="form-group">
              <label for="empJoinDate">Date of Joining *</label>
              <input type="date" id="empJoinDate" name="empJoinDate" required />
            </div>
            <div class="form-group">
              <label for="empExitDate">Date of Exit</label>
              <input type="date" id="empExitDate" name="empExitDate" />
            </div>

            <!-- Salary Details -->
            <div class="form-group">
              <label for="empBasicSalary">Basic Salary *</label>
              <input
                type="number"
                id="empBasicSalary"
                name="empBasicSalary"
                placeholder="25000"
                step="0.01"
                required
              />
            </div>
            <div class="form-group">
              <label for="empDearnessAllowance">Dearness Allowance</label>
              <input
                type="number"
                id="empDearnessAllowance"
                name="empDearnessAllowance"
                placeholder="2000"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="empPersonalAllowance">Personal Allowance</label>
              <input
                type="number"
                id="empPersonalAllowance"
                name="empPersonalAllowance"
                placeholder="1500"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="empConveyanceAllowance">Conveyance Allowance</label>
              <input
                type="number"
                id="empConveyanceAllowance"
                name="empConveyanceAllowance"
                placeholder="1000"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="empProfessionalAllowance"
                >Professional Allowance</label
              >
              <input
                type="number"
                id="empProfessionalAllowance"
                name="empProfessionalAllowance"
                placeholder="2000"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="empBonus">Bonus</label>
              <input
                type="number"
                id="empBonus"
                name="empBonus"
                placeholder="5000"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="empGrossSalary">Gross Salary (Auto-calculated)</label>
              <input
                type="number"
                id="empGrossSalary"
                name="empGrossSalary"
                readonly
                style="background: rgba(255, 255, 255, 0.05)"
              />
            </div>
          </div>

          <button type="submit" class="btn-submit">
            Add Employee to Firebase
          </button>

          <div id="stepIndicator" class="step-indicator">
            Step 1: Validating data...
          </div>

          <div id="successMessage" class="success-message">
            Employee added successfully!
          </div>
        </form>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAnalytics,
        logEvent,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        get,
        child,
        remove,
        update,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyB1wIsDf1qSLaIGyQvbri26z9e4ypxF-lw",
        authDomain: "apikawachi.firebaseapp.com",
        databaseURL:
          "https://apikawachi-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "apikawachi",
        storageBucket: "apikawachi.appspot.com",
        messagingSenderId: "7573902945",
        appId: "1:7573902945:web:be2c051ef0d0ceed787c20",
        measurementId: "G-GT0F7K4NLP",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const database = getDatabase(app);

      // Global variables to make Firebase available to other scripts
      window.firebaseApp = app;
      window.firebaseDatabase = database;
      window.firebaseAnalytics = analytics;
      window.firebaseRef = ref;
      window.firebasePush = push;
      window.firebaseSet = set;
      window.firebaseGet = get;
      window.firebaseChild = child;
      window.firebaseRemove = remove;
      window.firebaseUpdate = update;
      window.firebaseOnValue = onValue;
      window.firebaseLogEvent = logEvent;

      // Signal that Firebase is ready
      window.firebaseReady = true;

      // Employee management functions
      window.employeeAPI = {
        async addEmployee(employeeData) {
          try {
            // Validate required fields
            if (
              !employeeData.empId ||
              !employeeData.name ||
              !employeeData.contact ||
              !employeeData.email ||
              !employeeData.joinDate ||
              !employeeData.basicSalary
            ) {
              throw new Error(
                "Missing required fields: Employee ID, Name, Contact, Email, Join Date, or Basic Salary",
              );
            }

            // Check if employee ID already exists
            const existingEmp = await this.getEmployeeById(employeeData.empId);
            if (existingEmp.success && existingEmp.data) {
              throw new Error(
                `Employee ID ${employeeData.empId} already exists`,
              );
            }

            // Prepare data for Firebase
            const firebaseEmployeeData = {
              empId: String(employeeData.empId).trim().toUpperCase(),
              name: String(employeeData.name).trim(),
              contact: String(employeeData.contact).trim(),
              email: String(employeeData.email).trim().toLowerCase(),
              maritalStatus: employeeData.maritalStatus || "",
              emergencyContact: employeeData.emergencyContact || "",
              address: employeeData.address || "",
              pan: String(employeeData.pan || "")
                .trim()
                .toUpperCase(),
              aadhar: String(employeeData.aadhar || "").trim(),
              uan: String(employeeData.uan || "").trim(),
              joinDate: employeeData.joinDate,
              exitDate: employeeData.exitDate || "",
              basicSalary: parseFloat(employeeData.basicSalary) || 0,
              dearnessAllowance:
                parseFloat(employeeData.dearnessAllowance) || 0,
              personalAllowance:
                parseFloat(employeeData.personalAllowance) || 0,
              conveyanceAllowance:
                parseFloat(employeeData.conveyanceAllowance) || 0,
              professionalAllowance:
                parseFloat(employeeData.professionalAllowance) || 0,
              bonus: parseFloat(employeeData.bonus) || 0,
              grossSalary: parseFloat(employeeData.grossSalary) || 0,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
              status: "active",
            };

            // Save to Firebase with Employee ID as key
            const employeeRef = ref(
              database,
              `employees/${firebaseEmployeeData.empId}`,
            );
            await set(employeeRef, firebaseEmployeeData);

            console.log(
              "✅ Employee successfully saved to Firebase:",
              firebaseEmployeeData.empId,
            );

            // Log analytics
            logEvent(analytics, "employee_added", {
              empId: firebaseEmployeeData.empId,
              name: firebaseEmployeeData.name,
            });

            return {
              success: true,
              id: firebaseEmployeeData.empId,
              data: firebaseEmployeeData,
            };
          } catch (error) {
            console.error("❌ Error adding employee to Firebase:", error);
            logEvent(analytics, "employee_add_error", {
              error_message: error.message,
            });
            return {
              success: false,
              error: error.message,
            };
          }
        },

        async getAllEmployees() {
          try {
            const employeesRef = ref(database, "employees");
            const snapshot = await get(employeesRef);
            if (snapshot.exists()) {
              const employees = [];
              snapshot.forEach((childSnapshot) => {
                employees.push({
                  ...childSnapshot.val(),
                });
              });
              return { success: true, data: employees };
            } else {
              return { success: true, data: [] };
            }
          } catch (error) {
            console.error("Error fetching employees:", error);
            return { success: false, error: error.message };
          }
        },

        async getEmployeeById(empId) {
          try {
            const employeeRef = ref(
              database,
              `employees/${empId.toUpperCase()}`,
            );
            const snapshot = await get(employeeRef);
            if (snapshot.exists()) {
              return { success: true, data: snapshot.val() };
            } else {
              return { success: true, data: null };
            }
          } catch (error) {
            console.error("Error fetching employee:", error);
            return { success: false, error: error.message };
          }
        },

        async updateEmployee(empId, updateData) {
          try {
            // Prepare data for Firebase update
            const firebaseUpdateData = {
              name: String(updateData.name || "").trim(),
              contact: String(updateData.contact || "").trim(),
              email: String(updateData.email || "")
                .trim()
                .toLowerCase(),
              maritalStatus: updateData.maritalStatus || "",
              emergencyContact: updateData.emergencyContact || "",
              address: updateData.address || "",
              pan: String(updateData.pan || "")
                .trim()
                .toUpperCase(),
              aadhar: String(updateData.aadhar || "").trim(),
              uan: String(updateData.uan || "").trim(),
              joinDate: updateData.joinDate || "",
              exitDate: updateData.exitDate || "",
              basicSalary: parseFloat(updateData.basicSalary) || 0,
              dearnessAllowance: parseFloat(updateData.dearnessAllowance) || 0,
              personalAllowance: parseFloat(updateData.personalAllowance) || 0,
              conveyanceAllowance:
                parseFloat(updateData.conveyanceAllowance) || 0,
              professionalAllowance:
                parseFloat(updateData.professionalAllowance) || 0,
              bonus: parseFloat(updateData.bonus) || 0,
              grossSalary: parseFloat(updateData.grossSalary) || 0,
              updatedAt: new Date().toISOString(),
            };

            const employeeRef = ref(database, `employees/${empId}`);
            await update(employeeRef, firebaseUpdateData);

            console.log("✅ Employee successfully updated in Firebase:", empId);

            // Log analytics
            logEvent(analytics, "employee_updated", {
              empId: empId,
              name: firebaseUpdateData.name,
            });

            return { success: true };
          } catch (error) {
            console.error("Error updating employee:", error);

            // Log error analytics
            logEvent(analytics, "employee_update_error", {
              empId: empId,
              error_message: error.message,
            });

            return { success: false, error: error.message };
          }
        },

        async deleteEmployee(empId) {
          try {
            const employeeRef = ref(database, `employees/${empId}`);
            await remove(employeeRef);
            logEvent(analytics, "employee_deleted", { empId: empId });
            return { success: true };
          } catch (error) {
            console.error("Error deleting employee:", error);
            return { success: false, error: error.message };
          }
        },
      };

      // Initialize the page
      loadEmployees();

      // Trigger connection check
      setTimeout(() => {
        if (typeof window.checkFirebaseConnection === "function") {
          window.checkFirebaseConnection();
        }
      }, 500);
    </script>

    <!-- XLSX library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
      let currentEmployees = [];

      // Authentication check
      if (sessionStorage.getItem("isLoggedIn") !== "true") {
        sessionStorage.setItem("redirectAfterLogin", window.location.pathname);
        window.location.href = "login.html";
      }

      // Global Firebase connection functions
      function updateFirebaseStatus(connected = false) {
        const indicator = document.getElementById("firebaseIndicator");
        const statusText = document.getElementById("firebaseStatusText");

        if (indicator && statusText) {
          if (connected) {
            indicator.style.background = "#27ae60";
            statusText.textContent = "🔥 Connected to Firebase";
            statusText.style.color = "#27ae60";
          } else {
            indicator.style.background = "#ff4757";
            statusText.textContent = "❌ Firebase Disconnected";
            statusText.style.color = "#ff4757";
          }
        }
      }

      // Test Firebase connection
      async function checkFirebaseConnection() {
        try {
          if (
            !window.firebaseDatabase ||
            !window.firebaseRef ||
            !window.firebaseGet
          ) {
            console.log("Firebase not yet available, waiting...");
            updateFirebaseStatus(false);
            return false;
          }

          const employeesRef = window.firebaseRef(
            window.firebaseDatabase,
            "employees",
          );
          const snapshot = await window.firebaseGet(employeesRef);

          console.log("✅ Firebase connection test successful");
          updateFirebaseStatus(true);
          return true;
        } catch (error) {
          console.error("❌ Firebase connection test failed:", error);
          updateFirebaseStatus(false);
          return false;
        }
      }

      // Make functions globally accessible
      window.updateFirebaseStatus = updateFirebaseStatus;
      window.checkFirebaseConnection = checkFirebaseConnection;

      // Calculate gross salary automatically
      function calculateGrossSalary() {
        const basic =
          parseFloat(document.getElementById("empBasicSalary").value) || 0;
        const dearness =
          parseFloat(document.getElementById("empDearnessAllowance").value) ||
          0;
        const personal =
          parseFloat(document.getElementById("empPersonalAllowance").value) ||
          0;
        const conveyance =
          parseFloat(document.getElementById("empConveyanceAllowance").value) ||
          0;
        const professional =
          parseFloat(
            document.getElementById("empProfessionalAllowance").value,
          ) || 0;
        const bonus =
          parseFloat(document.getElementById("empBonus").value) || 0;

        const gross =
          basic + dearness + personal + conveyance + professional + bonus;
        document.getElementById("empGrossSalary").value = gross.toFixed(2);
      }

      // Add event listeners for salary calculation
      document.addEventListener("DOMContentLoaded", () => {
        const salaryFields = [
          "empBasicSalary",
          "empDearnessAllowance",
          "empPersonalAllowance",
          "empConveyanceAllowance",
          "empProfessionalAllowance",
          "empBonus",
        ];
        salaryFields.forEach((fieldId) => {
          const field = document.getElementById(fieldId);
          if (field) {
            field.addEventListener("input", calculateGrossSalary);
          }
        });

        // Add event listeners for edit form salary calculation
        const editSalaryFields = [
          "editEmpBasicSalary",
          "editEmpDearnessAllowance",
          "editEmpPersonalAllowance",
          "editEmpConveyanceAllowance",
          "editEmpProfessionalAllowance",
          "editEmpBonus",
        ];
        editSalaryFields.forEach((fieldId) => {
          const field = document.getElementById(fieldId);
          if (field) {
            field.addEventListener("input", calculateEditGrossSalary);
          }
        });
      });

      // Load employees from Firebase
      async function loadEmployees() {
        try {
          const result = await window.employeeAPI.getAllEmployees();
          if (result.success) {
            currentEmployees = result.data;
            displayEmployees(currentEmployees);
            document.getElementById("loadingMessage").style.display = "none";
          } else {
            console.error("Failed to load employees:", result.error);
            document.getElementById("loadingMessage").textContent =
              "Failed to load employees. Please try again.";
          }
        } catch (error) {
          console.error("Error loading employees:", error);
          document.getElementById("loadingMessage").textContent =
            "Error loading employees. Please check your connection.";
        }
      }

      // Display employees in the UI
      function displayEmployees(employees) {
        const container = document.getElementById("teamContainer");
        container.innerHTML = "";

        if (employees.length === 0) {
          container.innerHTML =
            '<div class="loading">No employees found. Add your first employee!</div>';
          return;
        }

        employees.forEach((emp) => {
          const card = document.createElement("div");
          card.classList.add("profile-card");
          card.innerHTML = `
          <div class="profile-header">
            <h3>${emp.name}</h3>
            <span class="emp-id">id=${emp.empId}</span>
          </div>
          <div class="info-grid">
            <div class="info-row">
              <span class="info-label">Contact:</span>
              <span class="info-value">${emp.contact}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Email:</span>
              <span class="info-value">${emp.email}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Join Date:</span>
              <span class="info-value">${formatDate(emp.joinDate)}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Basic Salary:</span>
              <span class="info-value">₹${emp.basicSalary?.toLocaleString()}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Gross Salary:</span>
              <span class="info-value">₹${emp.grossSalary?.toLocaleString()}</span>
            </div>
          </div>
          <div class="employee-actions">
            <button class="btn-edit" onclick="editEmployee('${emp.empId}')">
              <i class='bx bx-edit'></i> Edit
            </button>
            <button class="btn-delete" onclick="deleteEmployee('${emp.empId}')">
              <i class='bx bx-trash'></i> Delete
            </button>
          </div>
        `;
          container.appendChild(card);
        });
      }

      // Toggle fetch section
      function toggleFetchSection() {
        const section = document.getElementById("fetchSection");
        section.style.display =
          section.style.display === "none" ? "block" : "none";
      }

      // Fetch employee by ID
      async function fetchEmployeeById() {
        const empId = document.getElementById("fetchEmpId").value.trim();
        const resultDiv = document.getElementById("fetchResult");

        if (!empId) {
          alert("Please enter an Employee ID");
          return;
        }

        resultDiv.innerHTML =
          '<div class="loading">Fetching employee data...</div>';

        try {
          const result = await window.employeeAPI.getEmployeeById(empId);

          if (result.success && result.data) {
            const emp = result.data;
            resultDiv.innerHTML = `
            <div class="employee-details">
              <div class="details-header">
                <h3>${emp.name} (${emp.empId})</h3>
              </div>
              <div class="details-grid">
                <div class="detail-section">
                  <div class="section-title">Personal Information</div>
                  <div class="info-row"><span class="info-label">Name:</span><span class="info-value">${emp.name}</span></div>
                  <div class="info-row"><span class="info-label">Contact:</span><span class="info-value">${emp.contact}</span></div>
                  <div class="info-row"><span class="info-label">Email:</span><span class="info-value">${emp.email}</span></div>
                  <div class="info-row"><span class="info-label">Marital Status:</span><span class="info-value">${emp.maritalStatus || "N/A"}</span></div>
                  <div class="info-row"><span class="info-label">Emergency Contact:</span><span class="info-value">${emp.emergencyContact || "N/A"}</span></div>
                  <div class="info-row"><span class="info-label">Address:</span><span class="info-value">${emp.address || "N/A"}</span></div>
                </div>
                <div class="detail-section">
                  <div class="section-title">Government IDs</div>
                  <div class="info-row"><span class="info-label">PAN:</span><span class="info-value">${emp.pan || "N/A"}</span></div>
                  <div class="info-row"><span class="info-label">Aadhar:</span><span class="info-value">${emp.aadhar || "N/A"}</span></div>
                  <div class="info-row"><span class="info-label">UAN:</span><span class="info-value">${emp.uan || "N/A"}</span></div>
                </div>
                <div class="detail-section">
                  <div class="section-title">Employment</div>
                  <div class="info-row"><span class="info-label">Join Date:</span><span class="info-value">${formatDate(emp.joinDate)}</span></div>
                  <div class="info-row"><span class="info-label">Exit Date:</span><span class="info-value">${emp.exitDate ? formatDate(emp.exitDate) : "Active"}</span></div>
                  <div class="info-row"><span class="info-label">Status:</span><span class="info-value">${emp.status || "Active"}</span></div>
                </div>
                <div class="detail-section">
                  <div class="section-title">Salary Details</div>
                  <div class="info-row"><span class="info-label">Basic Salary:</span><span class="info-value">₹${emp.basicSalary?.toLocaleString()}</span></div>
                  <div class="info-row"><span class="info-label">Dearness Allowance:</span><span class="info-value">₹${emp.dearnessAllowance?.toLocaleString()}</span></div>
                  <div class="info-row"><span class="info-label">Personal Allowance:</span><span class="info-value">₹${emp.personalAllowance?.toLocaleString()}</span></div>
                  <div class="info-row"><span class="info-label">Conveyance Allowance:</span><span class="info-value">₹${emp.conveyanceAllowance?.toLocaleString()}</span></div>
                  <div class="info-row"><span class="info-label">Professional Allowance:</span><span class="info-value">₹${emp.professionalAllowance?.toLocaleString()}</span></div>
                  <div class="info-row"><span class="info-label">Bonus:</span><span class="info-value">₹${emp.bonus?.toLocaleString()}</span></div>
                  <div class="info-row"><span class="info-label"><strong>Gross Salary:</strong></span><span class="info-value"><strong>₹${emp.grossSalary?.toLocaleString()}</strong></span></div>
                </div>
              </div>
            </div>
          `;
          } else {
            resultDiv.innerHTML = `<div style="color: #ff4757; text-align: center; padding: 20px;">Employee with ID "${empId}" not found.</div>`;
          }
        } catch (error) {
          console.error("Error fetching employee:", error);
          resultDiv.innerHTML = `<div style="color: #ff4757; text-align: center; padding: 20px;">Error fetching employee: ${error.message}</div>`;
        }
      }

      // Modal functions
      function showAddEmployeeModal() {
        document.getElementById("addEmployeeModal").style.display = "flex";

        // Check Firebase connection when modal opens
        try {
          if (typeof window.checkFirebaseConnection === "function") {
            window.checkFirebaseConnection();
          } else if (typeof checkFirebaseConnection === "function") {
            checkFirebaseConnection();
          } else {
            console.warn(
              "checkFirebaseConnection function not available yet, will retry...",
            );
            if (typeof updateFirebaseStatus === "function") {
              updateFirebaseStatus(false);
            }

            setTimeout(() => {
              if (typeof window.checkFirebaseConnection === "function") {
                window.checkFirebaseConnection();
              }
            }, 1000);
          }
        } catch (error) {
          console.error("Error checking Firebase connection:", error);
          const indicator = document.getElementById("firebaseIndicator");
          const statusText = document.getElementById("firebaseStatusText");
          if (indicator && statusText) {
            indicator.style.background = "#ff4757";
            statusText.textContent = "❌ Firebase Check Failed";
            statusText.style.color = "#ff4757";
          }
        }
      }

      function hideAddEmployeeModal() {
        document.getElementById("addEmployeeModal").style.display = "none";
        document.getElementById("addEmployeeForm").reset();
        document.getElementById("successMessage").style.display = "none";

        const stepIndicator = document.getElementById("stepIndicator");
        stepIndicator.style.display = "none";
        stepIndicator.style.background = "rgba(0, 114, 255, 0.1)";
        stepIndicator.style.borderColor = "rgba(0, 114, 255, 0.3)";
        stepIndicator.style.color = "#00c6ff";

        const submitButton = document.querySelector(".btn-submit");
        submitButton.innerHTML = "Add Employee to Firebase";
        submitButton.style.background =
          "linear-gradient(to right, rgb(0, 114, 255), rgb(0, 198, 255))";
        submitButton.disabled = false;
      }

      // Handle form submission
      async function handleAddEmployee(event) {
        event.preventDefault();

        const submitButton = document.querySelector(".btn-submit");
        const successMessage = document.getElementById("successMessage");
        const stepIndicator = document.getElementById("stepIndicator");
        const originalButtonText = submitButton.innerHTML;

        // Step 1: Show validation
        stepIndicator.innerHTML = "🔍 Step 1: Validating employee data...";
        stepIndicator.style.display = "block";
        submitButton.disabled = true;

        const formData = new FormData(event.target);
        const employeeData = {
          empId: formData.get("empId"),
          name: formData.get("empName"),
          contact: formData.get("empContact"),
          email: formData.get("empEmail"),
          maritalStatus: formData.get("empMaritalStatus"),
          emergencyContact: formData.get("empEmergencyContact"),
          address: formData.get("empAddress"),
          pan: formData.get("empPan"),
          aadhar: formData.get("empAadhar"),
          uan: formData.get("empUan"),
          joinDate: formData.get("empJoinDate"),
          exitDate: formData.get("empExitDate"),
          basicSalary: formData.get("empBasicSalary"),
          dearnessAllowance: formData.get("empDearnessAllowance"),
          personalAllowance: formData.get("empPersonalAllowance"),
          conveyanceAllowance: formData.get("empConveyanceAllowance"),
          professionalAllowance: formData.get("empProfessionalAllowance"),
          bonus: formData.get("empBonus"),
          grossSalary: formData.get("empGrossSalary"),
        };

        // Validate required fields
        if (
          !employeeData.empId ||
          !employeeData.name ||
          !employeeData.contact ||
          !employeeData.email ||
          !employeeData.joinDate ||
          !employeeData.basicSalary
        ) {
          stepIndicator.innerHTML =
            "❌ Validation failed: Please fill in all required fields";
          stepIndicator.style.background = "rgba(231, 76, 60, 0.1)";
          stepIndicator.style.borderColor = "rgba(231, 76, 60, 0.3)";
          stepIndicator.style.color = "#ff4757";
          submitButton.disabled = false;
          setTimeout(() => {
            stepIndicator.style.display = "none";
          }, 3000);
          return;
        }

        // Step 2: Data validated, connecting to Firebase
        stepIndicator.innerHTML =
          "✅ Step 2: Data validated, connecting to Firebase...";
        stepIndicator.style.background = "rgba(0, 114, 255, 0.1)";
        stepIndicator.style.borderColor = "rgba(0, 114, 255, 0.3)";
        stepIndicator.style.color = "#00c6ff";
        submitButton.innerHTML = "🔗 Connecting to Firebase...";

        await new Promise((resolve) => setTimeout(resolve, 500));

        try {
          // Step 3: Saving to Firebase
          stepIndicator.innerHTML =
            "🔥 Step 3: Saving employee to Firebase database...";
          submitButton.innerHTML = "💾 Saving to Firebase...";

          const result = await window.employeeAPI.addEmployee(employeeData);

          if (result.success) {
            // Step 4: Success
            stepIndicator.innerHTML =
              "🎉 Step 4: Employee successfully saved to Firebase!";
            stepIndicator.style.background = "rgba(39, 174, 96, 0.1)";
            stepIndicator.style.borderColor = "rgba(39, 174, 96, 0.3)";
            stepIndicator.style.color = "#27ae60";

            successMessage.innerHTML = `
            ✅ Employee saved to Firebase successfully!<br>
            <small>Employee ID: ${result.id}</small><br>
            <small>Name: ${employeeData.name}</small>
          `;
            successMessage.style.display = "block";
            successMessage.style.color = "#27ae60";

            submitButton.innerHTML = "✅ Saved to Firebase!";
            submitButton.style.background =
              "linear-gradient(to right, #27ae60, #2ecc71)";

            // Step 5: Refreshing data
            stepIndicator.innerHTML = "🔄 Step 5: Refreshing employee list...";
            await loadEmployees();

            stepIndicator.innerHTML =
              "✨ Complete! Employee added successfully to Firebase!";
            stepIndicator.style.background = "rgba(39, 174, 96, 0.2)";
            stepIndicator.style.borderColor = "rgba(39, 174, 96, 0.5)";

            setTimeout(() => {
              hideAddEmployeeModal();
              submitButton.innerHTML = originalButtonText;
              submitButton.style.background =
                "linear-gradient(to right, rgb(0, 114, 255), rgb(0, 198, 255))";
              submitButton.disabled = false;
            }, 2500);
          } else {
            stepIndicator.innerHTML = `❌ Step 3 Failed: ${result.error || "Unknown Firebase error"}`;
            stepIndicator.style.background = "rgba(231, 76, 60, 0.1)";
            stepIndicator.style.borderColor = "rgba(231, 76, 60, 0.3)";
            stepIndicator.style.color = "#ff4757";

            submitButton.innerHTML = "❌ Firebase Error";
            submitButton.style.background =
              "linear-gradient(to right, #e74c3c, #c0392b)";

            successMessage.innerHTML = `❌ Failed to save to Firebase: ${result.error || "Unknown error"}`;
            successMessage.style.display = "block";
            successMessage.style.color = "#ff4757";

            setTimeout(() => {
              submitButton.innerHTML = originalButtonText;
              submitButton.style.background =
                "linear-gradient(to right, rgb(0, 114, 255), rgb(0, 198, 255))";
              submitButton.disabled = false;
            }, 3000);
          }
        } catch (error) {
          console.error("Form submission error:", error);

          stepIndicator.innerHTML = `❌ Connection Error: ${error.message}`;
          stepIndicator.style.background = "rgba(231, 76, 60, 0.1)";
          stepIndicator.style.borderColor = "rgba(231, 76, 60, 0.3)";
          stepIndicator.style.color = "#ff4757";

          submitButton.innerHTML = "❌ Connection Error";
          submitButton.style.background =
            "linear-gradient(to right, #e74c3c, #c0392b)";

          successMessage.innerHTML = `❌ Network error: ${error.message}`;
          successMessage.style.display = "block";
          successMessage.style.color = "#ff4757";

          setTimeout(() => {
            submitButton.innerHTML = originalButtonText;
            submitButton.style.background =
              "linear-gradient(to right, rgb(0, 114, 255), rgb(0, 198, 255))";
            submitButton.disabled = false;
          }, 3000);
        }
      }

      // Edit employee function
      async function editEmployee(empId) {
        try {
          // Fetch employee data
          const result = await window.employeeAPI.getEmployeeById(empId);

          if (result.success && result.data) {
            const emp = result.data;

            // Fill the edit form with current data
            document.getElementById("editEmpId").value = emp.empId || "";
            document.getElementById("editEmpName").value = emp.name || "";
            document.getElementById("editEmpContact").value = emp.contact || "";
            document.getElementById("editEmpEmail").value = emp.email || "";
            document.getElementById("editEmpMaritalStatus").value =
              emp.maritalStatus || "";
            document.getElementById("editEmpEmergencyContact").value =
              emp.emergencyContact || "";
            document.getElementById("editEmpAddress").value = emp.address || "";
            document.getElementById("editEmpPan").value = emp.pan || "";
            document.getElementById("editEmpAadhar").value = emp.aadhar || "";
            document.getElementById("editEmpUan").value = emp.uan || "";
            document.getElementById("editEmpJoinDate").value =
              emp.joinDate || "";
            document.getElementById("editEmpExitDate").value =
              emp.exitDate || "";
            document.getElementById("editEmpBasicSalary").value =
              emp.basicSalary || "";
            document.getElementById("editEmpDearnessAllowance").value =
              emp.dearnessAllowance || "";
            document.getElementById("editEmpPersonalAllowance").value =
              emp.personalAllowance || "";
            document.getElementById("editEmpConveyanceAllowance").value =
              emp.conveyanceAllowance || "";
            document.getElementById("editEmpProfessionalAllowance").value =
              emp.professionalAllowance || "";
            document.getElementById("editEmpBonus").value = emp.bonus || "";
            document.getElementById("editEmpGrossSalary").value =
              emp.grossSalary || "";

            // Show the edit modal
            document.getElementById("editEmployeeModal").style.display = "flex";

            // Check Firebase connection
            updateEditFirebaseStatus(true);

            // Calculate gross salary for the edit form
            calculateEditGrossSalary();
          } else {
            alert("Employee not found or error fetching data");
          }
        } catch (error) {
          console.error("Error loading employee for edit:", error);
          alert("Error loading employee data: " + error.message);
        }
      }

      // Hide edit employee modal
      function hideEditEmployeeModal() {
        document.getElementById("editEmployeeModal").style.display = "none";
        document.getElementById("editEmployeeForm").reset();
        document.getElementById("editSuccessMessage").style.display = "none";

        const stepIndicator = document.getElementById("editStepIndicator");
        stepIndicator.style.display = "none";
        stepIndicator.style.background = "rgba(0, 114, 255, 0.1)";
        stepIndicator.style.borderColor = "rgba(0, 114, 255, 0.3)";
        stepIndicator.style.color = "#00c6ff";

        const submitButton = document.querySelector(
          "#editEmployeeForm .btn-submit",
        );
        if (submitButton) {
          submitButton.innerHTML = "Update Employee in Firebase";
          submitButton.style.background =
            "linear-gradient(to right, rgb(0, 114, 255), rgb(0, 198, 255))";
          submitButton.disabled = false;
        }
      }

      // Update Firebase status for edit modal
      function updateEditFirebaseStatus(connected = false) {
        const indicator = document.getElementById("editFirebaseIndicator");
        const statusText = document.getElementById("editFirebaseStatusText");

        if (indicator && statusText) {
          if (connected) {
            indicator.style.background = "#27ae60";
            statusText.textContent = "🔥 Connected to Firebase";
            statusText.style.color = "#27ae60";
          } else {
            indicator.style.background = "#ff4757";
            statusText.textContent = "❌ Firebase Disconnected";
            statusText.style.color = "#ff4757";
          }
        }
      }

      // Calculate gross salary for edit form
      function calculateEditGrossSalary() {
        const basic =
          parseFloat(document.getElementById("editEmpBasicSalary").value) || 0;
        const dearness =
          parseFloat(
            document.getElementById("editEmpDearnessAllowance").value,
          ) || 0;
        const personal =
          parseFloat(
            document.getElementById("editEmpPersonalAllowance").value,
          ) || 0;
        const conveyance =
          parseFloat(
            document.getElementById("editEmpConveyanceAllowance").value,
          ) || 0;
        const professional =
          parseFloat(
            document.getElementById("editEmpProfessionalAllowance").value,
          ) || 0;
        const bonus =
          parseFloat(document.getElementById("editEmpBonus").value) || 0;

        const gross =
          basic + dearness + personal + conveyance + professional + bonus;
        document.getElementById("editEmpGrossSalary").value = gross.toFixed(2);
      }

      // Handle edit employee form submission
      async function handleEditEmployee(event) {
        event.preventDefault();

        const submitButton = document.querySelector(
          "#editEmployeeForm .btn-submit",
        );
        const successMessage = document.getElementById("editSuccessMessage");
        const stepIndicator = document.getElementById("editStepIndicator");
        const originalButtonText = submitButton.innerHTML;

        // Step 1: Show validation
        stepIndicator.innerHTML = "🔍 Step 1: Validating employee data...";
        stepIndicator.style.display = "block";
        submitButton.disabled = true;

        const formData = new FormData(event.target);
        const employeeData = {
          empId: formData.get("empId"),
          name: formData.get("empName"),
          contact: formData.get("empContact"),
          email: formData.get("empEmail"),
          maritalStatus: formData.get("empMaritalStatus"),
          emergencyContact: formData.get("empEmergencyContact"),
          address: formData.get("empAddress"),
          pan: formData.get("empPan"),
          aadhar: formData.get("empAadhar"),
          uan: formData.get("empUan"),
          joinDate: formData.get("empJoinDate"),
          exitDate: formData.get("empExitDate"),
          basicSalary: formData.get("empBasicSalary"),
          dearnessAllowance: formData.get("empDearnessAllowance"),
          personalAllowance: formData.get("empPersonalAllowance"),
          conveyanceAllowance: formData.get("empConveyanceAllowance"),
          professionalAllowance: formData.get("empProfessionalAllowance"),
          bonus: formData.get("empBonus"),
          grossSalary: formData.get("empGrossSalary"),
        };

        // Validate required fields
        if (
          !employeeData.empId ||
          !employeeData.name ||
          !employeeData.contact ||
          !employeeData.email ||
          !employeeData.joinDate ||
          !employeeData.basicSalary
        ) {
          stepIndicator.innerHTML =
            "❌ Validation failed: Please fill in all required fields";
          stepIndicator.style.background = "rgba(231, 76, 60, 0.1)";
          stepIndicator.style.borderColor = "rgba(231, 76, 60, 0.3)";
          stepIndicator.style.color = "#ff4757";
          submitButton.disabled = false;
          setTimeout(() => {
            stepIndicator.style.display = "none";
          }, 3000);
          return;
        }

        // Step 2: Data validated, connecting to Firebase
        stepIndicator.innerHTML =
          "✅ Step 2: Data validated, updating in Firebase...";
        stepIndicator.style.background = "rgba(0, 114, 255, 0.1)";
        stepIndicator.style.borderColor = "rgba(0, 114, 255, 0.3)";
        stepIndicator.style.color = "#00c6ff";
        submitButton.innerHTML = "🔗 Connecting to Firebase...";

        await new Promise((resolve) => setTimeout(resolve, 500));

        try {
          // Step 3: Updating in Firebase
          stepIndicator.innerHTML =
            "🔥 Step 3: Updating employee in Firebase database...";
          submitButton.innerHTML = "💾 Updating in Firebase...";

          // Prepare update data (remove empId since it's the key)
          const updateData = { ...employeeData };
          delete updateData.empId;

          const result = await window.employeeAPI.updateEmployee(
            employeeData.empId,
            updateData,
          );

          if (result.success) {
            // Step 4: Success
            stepIndicator.innerHTML =
              "🎉 Step 4: Employee successfully updated in Firebase!";
            stepIndicator.style.background = "rgba(39, 174, 96, 0.1)";
            stepIndicator.style.borderColor = "rgba(39, 174, 96, 0.3)";
            stepIndicator.style.color = "#27ae60";

            successMessage.innerHTML = `
            ✅ Employee updated in Firebase successfully!<br>
            <small>Employee ID: ${employeeData.empId}</small><br>
            <small>Name: ${employeeData.name}</small>
          `;
            successMessage.style.display = "block";
            successMessage.style.color = "#27ae60";

            submitButton.innerHTML = "✅ Updated in Firebase!";
            submitButton.style.background =
              "linear-gradient(to right, #27ae60, #2ecc71)";

            // Step 5: Refreshing data
            stepIndicator.innerHTML = "🔄 Step 5: Refreshing employee list...";
            await loadEmployees();

            stepIndicator.innerHTML =
              "✨ Complete! Employee updated successfully in Firebase!";
            stepIndicator.style.background = "rgba(39, 174, 96, 0.2)";
            stepIndicator.style.borderColor = "rgba(39, 174, 96, 0.5)";

            setTimeout(() => {
              hideEditEmployeeModal();
              submitButton.innerHTML = originalButtonText;
              submitButton.style.background =
                "linear-gradient(to right, rgb(0, 114, 255), rgb(0, 198, 255))";
              submitButton.disabled = false;
            }, 2500);
          } else {
            stepIndicator.innerHTML = `❌ Step 3 Failed: ${result.error || "Unknown Firebase error"}`;
            stepIndicator.style.background = "rgba(231, 76, 60, 0.1)";
            stepIndicator.style.borderColor = "rgba(231, 76, 60, 0.3)";
            stepIndicator.style.color = "#ff4757";

            submitButton.innerHTML = "❌ Firebase Error";
            submitButton.style.background =
              "linear-gradient(to right, #e74c3c, #c0392b)";

            successMessage.innerHTML = `❌ Failed to update in Firebase: ${result.error || "Unknown error"}`;
            successMessage.style.display = "block";
            successMessage.style.color = "#ff4757";

            setTimeout(() => {
              submitButton.innerHTML = originalButtonText;
              submitButton.style.background =
                "linear-gradient(to right, rgb(0, 114, 255), rgb(0, 198, 255))";
              submitButton.disabled = false;
            }, 3000);
          }
        } catch (error) {
          console.error("Edit form submission error:", error);

          stepIndicator.innerHTML = `❌ Connection Error: ${error.message}`;
          stepIndicator.style.background = "rgba(231, 76, 60, 0.1)";
          stepIndicator.style.borderColor = "rgba(231, 76, 60, 0.3)";
          stepIndicator.style.color = "#ff4757";

          submitButton.innerHTML = "❌ Connection Error";
          submitButton.style.background =
            "linear-gradient(to right, #e74c3c, #c0392b)";

          successMessage.innerHTML = `❌ Network error: ${error.message}`;
          successMessage.style.display = "block";
          successMessage.style.color = "#ff4757";

          setTimeout(() => {
            submitButton.innerHTML = originalButtonText;
            submitButton.style.background =
              "linear-gradient(to right, rgb(0, 114, 255), rgb(0, 198, 255))";
            submitButton.disabled = false;
          }, 3000);
        }
      }

      // Delete employee function
      async function deleteEmployee(empId) {
        if (!confirm(`Are you sure you want to delete employee ${empId}?`))
          return;

        try {
          const result = await window.employeeAPI.deleteEmployee(empId);

          if (result.success) {
            await loadEmployees();
            alert("Employee deleted successfully!");
          } else {
            alert(
              "Error deleting employee: " + (result.error || "Unknown error"),
            );
          }
        } catch (error) {
          console.error("Error deleting employee:", error);
          alert("Error deleting employee: " + error.message);
        }
      }

      // Export to Excel function
      function exportToExcel() {
        try {
          if (currentEmployees.length === 0) {
            alert("No employee data to export.");
            return;
          }

          const wsData = [
            [
              "Emp_ID",
              "Name",
              "Contact Number",
              "Email",
              "Marital Status",
              "Emergency Contact",
              "Address",
              "PAN [10 Digits Alpha Numeric]",
              "Aadhar [12 digit Number]",
              "UAN [12 Digit Number]",
              "Date of Joining",
              "Date of Exit",
              "Basic Salary",
              "Dearness Allowance",
              "Personal Allowance",
              "Conveyance Allowance",
              "Professional Allowance",
              "Bonus",
              "Gross Salary",
            ],
          ];

          currentEmployees.forEach((emp) => {
            wsData.push([
              emp.empId,
              emp.name,
              emp.contact,
              emp.email,
              emp.maritalStatus || "",
              emp.emergencyContact || "",
              emp.address || "",
              emp.pan || "",
              emp.aadhar || "",
              emp.uan || "",
              emp.joinDate,
              emp.exitDate || "",
              emp.basicSalary || 0,
              emp.dearnessAllowance || 0,
              emp.personalAllowance || 0,
              emp.conveyanceAllowance || 0,
              emp.professionalAllowance || 0,
              emp.bonus || 0,
              emp.grossSalary || 0,
            ]);
          });

          const ws = XLSX.utils.aoa_to_sheet(wsData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Employees");

          const filename = `employees_complete_${new Date().toISOString().split("T")[0]}.xlsx`;
          XLSX.writeFile(wb, filename);

          if (window.firebaseLogEvent) {
            window.firebaseLogEvent(
              window.firebaseAnalytics,
              "export_employees",
              {
                count: currentEmployees.length,
              },
            );
          }

          alert("Employee data exported successfully!");
        } catch (error) {
          console.error("Error exporting to Excel:", error);
          alert("Error exporting to Excel: " + error.message);
        }
      }

      // Sync with Firebase function
      async function syncWithFirebase() {
        await loadEmployees();
        alert("Data synchronized with Firebase!");
      }

      // Utility function to format dates
      function formatDate(dateString) {
        try {
          const date = new Date(dateString);
          return date
            .toLocaleDateString("en-GB", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
            })
            .replace(/\//g, "-");
        } catch (error) {
          return dateString;
        }
      }

      // Make functions globally available
      window.showAddEmployeeModal = showAddEmployeeModal;
      window.hideAddEmployeeModal = hideAddEmployeeModal;
      window.handleAddEmployee = handleAddEmployee;
      window.editEmployee = editEmployee;
      window.hideEditEmployeeModal = hideEditEmployeeModal;
      window.handleEditEmployee = handleEditEmployee;
      window.calculateEditGrossSalary = calculateEditGrossSalary;
      window.updateEditFirebaseStatus = updateEditFirebaseStatus;
      window.deleteEmployee = deleteEmployee;
      window.exportToExcel = exportToExcel;
      window.syncWithFirebase = syncWithFirebase;
      window.toggleFetchSection = toggleFetchSection;
      window.fetchEmployeeById = fetchEmployeeById;

      // Initialize Firebase connection check after page loads
      window.addEventListener("load", () => {
        setTimeout(() => {
          if (window.firebaseReady) {
            console.log("🔥 Firebase ready, checking connection...");
            checkFirebaseConnection();
          } else {
            console.log("⏳ Firebase not ready yet, waiting...");
          }
        }, 2000);
      });
    </script>
  </body>
</html>
<script>
                window.addEventListener('message', (event) => {
                  const { data } = event;
                  if (!data?.type) {
                    return;
                  }

                  switch (data.type) {
                    case 'builder.evaluate': {
                      const text = data.data.text;
                      const args = data.data.arguments || [];
                      const id = data.data.id;
                      // tslint:disable-next-line:no-function-constructor-with-string-args
                      const fn = new Function(text);
                      let result;
                      let error = null;
                      try {
                        // eslint-disable-next-line prefer-spread
                        result = fn.apply(null, args);
                      } catch (err) {
                        error = err;
                      }

                      if (error) {
                        window.parent?.postMessage(
                          {
                            type: 'builder.evaluateError',
                            data: { id, error: error.message },
                          },
                          '*'
                        );
                      } else {
                        if (result && typeof result.then === 'function') {
                          result
                            .then((finalResult) => {
                              window.parent?.postMessage(
                                {
                                  type: 'builder.evaluateResult',
                                  data: { id, result: finalResult },
                                },
                                '*'
                              );
                            })
                            .catch(console.error);
                        } else {
                          window.parent?.postMessage(
                            {
                              type: 'builder.evaluateResult',
                              data: { result, id },
                            },
                            '*'
                          );
                        }
                      }
                      break;
                    }
                  }
                });

                window.addEventListener('error', (event) => {
                  window.parent?.postMessage(
                    {
                      type: 'builder.interactiveFrameError',
                      data: { message: event.error?.stack || event.error?.message || event.message },
                    },
                    '*'
                  );
                });
                
                setTimeout(() => {
                  const viteError = document.querySelector('vite-error-overlay')?.shadowRoot?.textContent;
                  if (typeof viteError === 'string') {
                    window.parent?.postMessage(
                      {
                        type: 'builder.interactiveFrameError',
                        data: { message: viteError },
                      },
                      '*'
                    );
                  }
                }, 500);

              </script>