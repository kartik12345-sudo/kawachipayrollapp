
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Biometric Attendance</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      body {
        background: #222d32;
        font-family: "Roboto", sans-serif;
      }

      .login-box {
        margin-top: 75px;
        height: auto;
        background: #1a2226;
        text-align: center;
        box-shadow:
          0 3px 6px rgba(0, 0, 0, 0.16),
          0 3px 6px rgba(0, 0, 0, 0.23);
      }

      .login-key {
        height: 100px;
        font-size: 80px;
        line-height: 100px;
        background: -webkit-linear-gradient(#27ef9f, #0db8de);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .login-title {
        margin-top: 15px;
        text-align: center;
        font-size: 30px;
        letter-spacing: 2px;
        font-weight: bold;
        color: #ecf0f5;
      }

      .login-form {
        margin-top: 25px;
        text-align: left;
      }

      input[type="text"],
      input[type="password"] {
        background-color: #1a2226;
        border: none;
        border-bottom: 2px solid #0db8de;
        border-radius: 0px;
        font-weight: bold;
        outline: 0;
        margin-bottom: 20px;
        padding-left: 0px;
        color: #ecf0f5;
        width: 100%;
      }

      .form-group {
        margin-bottom: 40px;
      }

      .form-control:focus {
        border-color: inherit;
        box-shadow: none;
        border-bottom: 2px solid #0db8de;
        background-color: #1a2226;
        color: #ecf0f5;
      }

      label {
        margin-bottom: 0px;
      }

      .form-control-label {
        font-size: 10px;
        color: #6c6c6c;
        font-weight: bold;
        letter-spacing: 1px;
      }

      .btn-outline-primary {
        border-color: #0db8de;
        color: #0db8de;
        border-radius: 0px;
        font-weight: bold;
        letter-spacing: 1px;
      }

      .btn-outline-primary:hover {
        background-color: #0db8de;
      }

      .login-btm {
        float: left;
      }

      .login-button {
        text-align: right;
        margin-bottom: 25px;
      }

      .login-text {
        text-align: left;
        padding-left: 0px;
        color: #a2a4a4;
      }

      .loginbttm {
        padding: 0px;
      }

      #userBar {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 10px 15px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        font-size: 14px;
        display: none;
      }

      .container-main {
        background: linear-gradient(145deg, #ffffff, #e6e9f0);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 800px;
        text-align: center;
        margin-top: 40px;
      }

      .employee-info-display {
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        text-align: left;
        border: 2px solid #0db8de;
      }

      .employee-info-display h4 {
        color: #0db8de;
        margin-bottom: 15px;
        text-align: center;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px solid #dee2e6;
      }

      .info-label {
        font-weight: bold;
        color: #495057;
      }

      .info-value {
        color: #212529;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      th,
      td {
        border: 1px solid #ccc;
        padding: 10px;
        font-size: 14px;
      }

      thead {
        background-color: #2575fc;
        color: white;
      }

      .attendance-summary {
        background: linear-gradient(145deg, #e3f2fd, #bbdefb);
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        border-left: 4px solid #2196f3;
      }

      .btn-primary,
      .btn-success,
      .btn-danger,
      .btn-warning,
      .btn-info,
      .btn-secondary {
        margin: 5px;
        min-width: 120px;
      }
    </style>
  </head>
  <body>
    <!-- Custom Login Page -->
    <div class="container" id="loginPage">
      <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8 login-box">
          <div class="col-lg-12 login-key">
            <i class="fa fa-key" aria-hidden="true"></i>
          </div>
          <div class="col-lg-12 login-title">BIOMETRIC ATTENDANCE</div>
          <div class="col-lg-12 login-form">
            <form onsubmit="login(event)">
              <div class="form-group">
                <label class="form-control-label">USERNAME</label>
                <input type="text" id="staffId" class="form-control" />
              </div>
              <div class="form-group">
                <label class="form-control-label">PASSWORD</label>
                <input
                  type="password"
                  id="staffPassword"
                  class="form-control"
                />
              </div>
              <div class="col-lg-12 loginbttm">
                <div class="col-lg-6 login-btm login-text" id="message"></div>
                <div class="col-lg-6 login-btm login-button">
                  <button type="submit" class="btn btn-outline-primary">
                    LOGIN
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Welcome User Bar -->
    <div id="userBar">
      <span id="userNameDisplay"></span>
      <button
        onclick="signOut()"
        style="margin-left: 10px; background-color: #e74c3c"
      >
        Close
      </button>
    </div>

    <!-- Main App -->
    <div class="container container-main" id="mainApp" style="display: none">
      <h1>Biometric Attendance System</h1>

      <!-- Employee ID Input -->
      <div class="form-group">
        <label for="employeeIdInput" style="color: #495057; font-weight: bold"
          >Employee ID</label
        >
        <input
          type="text"
          id="employeeIdInput"
          placeholder="Enter Employee ID (Case Sensitive - e.g., EMP001)"
          class="form-control"
          style="
            font-size: 16px;
            padding: 12px;
            border: 2px solid #0db8de;
            border-radius: 8px;
            background: white;
            color: #333;
            font-family: monospace;
          "
          onchange="fetchEmployeeData()"
        />
      </div>

      <!-- Employee Information Display -->
      <div id="employeeInfoDisplay" style="display: none"></div>

      <!-- Attendance Action Buttons -->
      <div id="attendanceActions" style="display: none">
        <button
          id="markAttendanceBtn"
          class="btn btn-success"
          onclick="markAttendance()"
        >
          üìç Mark Attendance
        </button>
        <button
          id="fetchFromAPI"
          class="btn btn-secondary"
          onclick="fetchAttendanceFromAPI()"
        >
          üîÑ Fetch from API
        </button>
        <button
          id="downloadExcel"
          class="btn btn-primary"
          onclick="downloadAttendanceExcel()"
        >
          üìä Download Excel
        </button>
        <button
          id="showAllBtn"
          class="btn btn-info"
          onclick="showAllAttendance()"
        >
          üìã Show All Records
        </button>
        <button
          id="clearDataBtn"
          class="btn btn-danger"
          onclick="clearAllData()"
        >
          üóëÔ∏è Clear All Data
        </button>
      </div>

      <!-- Attendance Details Display -->
      <div id="attendanceDetails" class="mt-4"></div>

      <!-- Fingerprint Display -->
      <div id="fingerprintContainer" style="display: none; margin-top: 20px">
        <canvas id="fingerprintCanvas" width="317" height="270"></canvas>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAnalytics,
        logEvent,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        get,
        remove,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyB1wIsDf1qSLaIGyQvbri26z9e4ypxF-lw",
        authDomain: "apikawachi.firebaseapp.com",
        databaseURL:
          "https://apikawachi-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "apikawachi",
        storageBucket: "apikawachi.appspot.com",
        messagingSenderId: "7573902945",
        appId: "1:7573902945:web:be2c051ef0d0ceed787c20",
        measurementId: "G-GT0F7K4NLP",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const database = getDatabase(app);

      // Make Firebase available globally
      window.firebaseApp = app;
      window.firebaseDatabase = database;
      window.firebaseAnalytics = analytics;
      window.firebaseRef = ref;
      window.firebasePush = push;
      window.firebaseSet = set;
      window.firebaseGet = get;
      window.firebaseRemove = remove;
      window.firebaseLogEvent = logEvent;
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      const staffMembers = [
        {
          id: "170712@ab",
          password: "OWNER@00014243774",
          position: "OWNER",
          name: "Aditya Bhardwaj",
        },
        {
          id: "310712@cb",
          password: "CO-OWNER@bhardwaj3107cb",
          position: "CO-OWNER",
          name: "Chandan Bhardwaj",
        },
        {
          id: "310712@db",
          password: "CO-OWNER@bhardwaj3107db",
          position: "CO-OWNER",
          name: "Deepak Bhardwaj",
        },
      ];

      let allAttendanceEntries = [];
      let employeesFromAPI = [];
      let currentEmployee = null;

      function login(e) {
        e.preventDefault();
        const id = document.getElementById("staffId").value.trim();
        const password = document.getElementById("staffPassword").value.trim();
        const found = staffMembers.find(
          (s) => s.id === id && s.password === password,
        );
        if (found) {
          localStorage.setItem("loggedInUser", JSON.stringify(found));
          showApp();
        } else {
          document.getElementById("message").textContent =
            "Invalid ID or Password.";
        }
      }

      function showApp() {
        const user = JSON.parse(localStorage.getItem("loggedInUser"));
        if (user) {
          document.getElementById("loginPage").style.display = "none";
          document.getElementById("mainApp").style.display = "block";
          document.getElementById("userBar").style.display = "block";
          document.getElementById("userNameDisplay").textContent =
            `Welcome, ${user.name}`;
        }
      }

      function signOut() {
        localStorage.removeItem("loggedInUser");
        currentEmployee = null;

        if (window.top && typeof window.top.hideIframe === "function") {
          window.top.hideIframe();
        }

        document.getElementById("mainApp").style.display = "none";
        document.getElementById("userBar").style.display = "none";
        document.getElementById("loginPage").style.display = "block";
        document.getElementById("employeeInfoDisplay").style.display = "none";
        document.getElementById("attendanceActions").style.display = "none";
      }

      // Fetch employee data by ID (case-sensitive)
      async function fetchEmployeeData() {
        const empId = document.getElementById("employeeIdInput").value.trim(); // Keep original case
        const infoDisplay = document.getElementById("employeeInfoDisplay");
        const actionsDiv = document.getElementById("attendanceActions");

        if (!empId) {
          infoDisplay.style.display = "none";
          actionsDiv.style.display = "none";
          currentEmployee = null;
          return;
        }

        try {
          // Fetch from Firebase with exact case match
          const employeeRef = window.firebaseRef(
            window.firebaseDatabase,
            `employees/${empId}`,
          ); // No case conversion
          const snapshot = await window.firebaseGet(employeeRef);

          if (snapshot.exists()) {
            currentEmployee = snapshot.val();
            displayEmployeeInfo(currentEmployee);
            actionsDiv.style.display = "block";
          } else {
            infoDisplay.innerHTML = `
        <div class="alert alert-warning">
          <h4>‚ö†Ô∏è Employee Not Found</h4>
          <p>Employee ID "${empId}" not found in the database.</p>
          <p>Please check the Employee ID or contact HR to add this employee.</p>
        </div>
      `;
            infoDisplay.style.display = "block";
            actionsDiv.style.display = "none";
            currentEmployee = null;
          }
        } catch (error) {
          console.error("Error fetching employee:", error);
          infoDisplay.innerHTML = `
      <div class="alert alert-danger">
        <h4>‚ùå Error</h4>
        <p>Failed to fetch employee data: ${error.message}</p>
      </div>
    `;
          infoDisplay.style.display = "block";
          actionsDiv.style.display = "none";
          currentEmployee = null;
        }
      }

      // Display employee information
      function displayEmployeeInfo(employee) {
        const infoDisplay = document.getElementById("employeeInfoDisplay");

        infoDisplay.innerHTML = `
    <div class="employee-info-display">
      <h4>üë§ Employee Information</h4>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">Employee ID:</span>
          <span class="info-value">${employee.empId}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Name:</span>
          <span class="info-value">${employee.name}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Contact:</span>
          <span class="info-value">${employee.contact}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Email:</span>
          <span class="info-value">${employee.email}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Join Date:</span>
          <span class="info-value">${formatDate(employee.joinDate)}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Basic Salary:</span>
          <span class="info-value">‚Çπ${employee.basicSalary?.toLocaleString()}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Gross Salary:</span>
          <span class="info-value">‚Çπ${employee.grossSalary?.toLocaleString()}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Status:</span>
          <span class="info-value">${employee.status || "Active"}</span>
        </div>
      </div>
    </div>
  `;

        infoDisplay.style.display = "block";
      }

      // Mark attendance for current employee
      async function markAttendance() {
        if (!currentEmployee) {
          alert("Please select an employee first.");
          return;
        }

        const date = new Date().toLocaleString();
        let ip = "Unknown",
          coords = "Unknown";

        try {
          const ipRes = await fetch("https://api.ipify.org?format=json");
          const ipData = await ipRes.json();
          ip = ipData.ip;
          const locRes = await fetch(`https://ipapi.co/${ip}/json/`);
          const locData = await locRes.json();
          coords = `${locData.latitude}, ${locData.longitude}`;
        } catch (error) {
          console.log("Location services not available");
        }

        const attendanceEntry = {
          empId: currentEmployee.empId,
          name: currentEmployee.name,
          contact: currentEmployee.contact,
          email: currentEmployee.email,
          basicSalary: currentEmployee.basicSalary,
          grossSalary: currentEmployee.grossSalary,
          date,
          ip,
          coords,
          timestamp: new Date().toISOString(),
        };

        // Save to Firebase
        try {
          if (window.firebaseDatabase) {
            const attendanceRef = window.firebaseRef(
              window.firebaseDatabase,
              "attendance",
            );
            const newAttendanceRef = window.firebasePush(attendanceRef);
            await window.firebaseSet(newAttendanceRef, {
              ...attendanceEntry,
              id: newAttendanceRef.key,
            });

            // Log analytics
            window.firebaseLogEvent(
              window.firebaseAnalytics,
              "attendance_recorded",
              {
                empId: attendanceEntry.empId,
                employee_name: attendanceEntry.name,
              },
            );

            console.log("Attendance saved to Firebase successfully");
          }
        } catch (error) {
          console.error("Error saving to Firebase:", error);
        }

        // Also keep in local array for immediate display
        allAttendanceEntries.push(attendanceEntry);

        document.getElementById("attendanceDetails").innerHTML = `
    <div class="attendance-summary">
      <h4>‚úÖ Attendance Marked Successfully</h4>
      <p><strong>Employee:</strong> ${attendanceEntry.name} (${attendanceEntry.empId})</p>
      <p><strong>Date & Time:</strong> ${date}</p>
      <p><strong>Location:</strong> ${coords}</p>
      <p><strong>IP Address:</strong> ${ip}</p>
      <p style="color: #00ff00;"><strong>‚úì Saved to Firebase Database</strong></p>
    </div>
  `;

        document.getElementById("fingerprintContainer").style.display = "block";
        const canvas = document.getElementById("fingerprintCanvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.src =
          "https://upload.wikimedia.org/wikipedia/commons/thumb/e/ef/Fingerprint_icon.svg/1200px-Fingerprint_icon.svg.png";
        img.onload = () =>
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      }

      // Fetch attendance data from Firebase API
      async function fetchAttendanceFromAPI() {
        try {
          if (!window.firebaseDatabase) {
            return alert("Firebase not initialized");
          }

          // Fetch attendance data
          const attendanceRef = window.firebaseRef(
            window.firebaseDatabase,
            "attendance",
          );
          const attendanceSnapshot = await window.firebaseGet(attendanceRef);

          // Fetch employee data
          const employeesRef = window.firebaseRef(
            window.firebaseDatabase,
            "employees",
          );
          const employeesSnapshot = await window.firebaseGet(employeesRef);

          let message = "Data fetched from Firebase API:\n\n";

          if (attendanceSnapshot.exists()) {
            const attendanceData = [];
            attendanceSnapshot.forEach((childSnapshot) => {
              attendanceData.push({
                id: childSnapshot.key,
                ...childSnapshot.val(),
              });
            });
            allAttendanceEntries = attendanceData;
            message += `üìä Attendance Records: ${attendanceData.length}\n`;
          } else {
            message += "üìä Attendance Records: 0\n";
          }

          if (employeesSnapshot.exists()) {
            employeesFromAPI = [];
            employeesSnapshot.forEach((childSnapshot) => {
              employeesFromAPI.push({
                ...childSnapshot.val(),
              });
            });
            message += `üë• Employee Records: ${employeesFromAPI.length}\n`;
          } else {
            message += "üë• Employee Records: 0\n";
          }

          alert(message + "\nData is now available for Excel export!");

          // Log analytics
          window.firebaseLogEvent(
            window.firebaseAnalytics,
            "data_fetched_from_api",
          );
        } catch (error) {
          console.error("Error fetching from Firebase:", error);
          alert("Error fetching data from Firebase: " + error.message);
        }
      }

      // Download attendance Excel with comprehensive data
      function downloadAttendanceExcel() {
        try {
          const wb = XLSX.utils.book_new();

          // Attendance data sheet
          if (allAttendanceEntries.length > 0) {
            const attendanceData = [
              [
                "S.No",
                "Emp_ID",
                "Name",
                "Contact Number",
                "Email",
                "Basic Salary",
                "Gross Salary",
                "Date & Time",
                "IP Address",
                "Coordinates",
                "Firebase ID",
              ],
            ];
            allAttendanceEntries.forEach((e, i) =>
              attendanceData.push([
                i + 1,
                e.empId || "N/A",
                e.name || "N/A",
                e.contact || "N/A",
                e.email || "N/A",
                e.basicSalary || 0,
                e.grossSalary || 0,
                e.date || e.timestamp,
                e.ip || "N/A",
                e.coords || "N/A",
                e.id || "Local",
              ]),
            );
            const attendanceWs = XLSX.utils.aoa_to_sheet(attendanceData);
            XLSX.utils.book_append_sheet(wb, attendanceWs, "Attendance");
          }

          // Employee data sheet (from API)
          if (employeesFromAPI.length > 0) {
            const employeeData = [
              [
                "Emp_ID",
                "Name",
                "Contact Number",
                "Email",
                "Marital Status",
                "Emergency Contact",
                "Address",
                "PAN [10 Digits Alpha Numeric]",
                "Aadhar [12 digit Number]",
                "UAN [12 Digit Number]",
                "Date of Joining",
                "Date of Exit",
                "Basic Salary",
                "Dearness Allowance",
                "Personal Allowance",
                "Conveyance Allowance",
                "Professional Allowance",
                "Bonus",
                "Gross Salary",
              ],
            ];
            employeesFromAPI.forEach((e, i) =>
              employeeData.push([
                e.empId,
                e.name,
                e.contact,
                e.email,
                e.maritalStatus || "",
                e.emergencyContact || "",
                e.address || "",
                e.pan || "",
                e.aadhar || "",
                e.uan || "",
                e.joinDate,
                e.exitDate || "",
                e.basicSalary || 0,
                e.dearnessAllowance || 0,
                e.personalAllowance || 0,
                e.conveyanceAllowance || 0,
                e.professionalAllowance || 0,
                e.bonus || 0,
                e.grossSalary || 0,
              ]),
            );
            const employeeWs = XLSX.utils.aoa_to_sheet(employeeData);
            XLSX.utils.book_append_sheet(
              wb,
              employeeWs,
              "Complete Employee Data",
            );
          }

          if (wb.SheetNames.length === 0) {
            return alert(
              "No data available. Use 'Fetch from API' to load data from Firebase first.",
            );
          }

          const filename = `biometric_attendance_${new Date().toISOString().split("T")[0]}.xlsx`;
          XLSX.writeFile(wb, filename);

          // Log analytics
          window.firebaseLogEvent(window.firebaseAnalytics, "excel_exported", {
            attendance_count: allAttendanceEntries.length,
            employee_count: employeesFromAPI.length,
          });

          alert(
            `Excel file "${filename}" downloaded successfully!\n\nContains:\n- ${allAttendanceEntries.length} attendance records\n- ${employeesFromAPI.length} complete employee records`,
          );
        } catch (error) {
          console.error("Error creating Excel file:", error);
          alert("Error creating Excel file: " + error.message);
        }
      }

      // Show all attendance records
      function showAllAttendance() {
        if (allAttendanceEntries.length === 0) {
          return alert(
            "No attendance records. Use 'Fetch from API' to load data from Firebase.",
          );
        }

        let html = `<h3>All Attendance Records (${allAttendanceEntries.length} entries)</h3><div style="overflow-x:auto;"><table><thead><tr>
    <th>#</th><th>Employee ID</th><th>Name</th><th>Date & Time</th><th>IP</th><th>Location</th><th>Salary</th><th>Firebase ID</th>
  </tr></thead><tbody>`;

        allAttendanceEntries.forEach((e, i) => {
          html += `<tr>
      <td>${i + 1}</td>
      <td>${e.empId || "N/A"}</td>
      <td>${e.name || "N/A"}</td>
      <td>${e.date || e.timestamp}</td>
      <td>${e.ip || "N/A"}</td>
      <td>${e.coords || "N/A"}</td>
      <td>‚Çπ${(e.grossSalary || 0).toLocaleString()}</td>
      <td>${e.id || "Local"}</td>
    </tr>`;
        });
        html += "</tbody></table></div>";
        document.getElementById("attendanceDetails").innerHTML = html;
      }

      // Clear all data
      async function clearAllData() {
        if (
          confirm(
            "Clear all attendance data? This will remove data from Firebase.",
          )
        ) {
          try {
            // Clear from Firebase
            if (window.firebaseDatabase) {
              const attendanceRef = window.firebaseRef(
                window.firebaseDatabase,
                "attendance",
              );
              await window.firebaseRemove(attendanceRef);
              console.log("Attendance data cleared from Firebase");
            }

            // Clear local data
            allAttendanceEntries = [];
            employeesFromAPI = [];

            // Clear displays
            document.getElementById("attendanceDetails").innerHTML = "";
            document.getElementById("fingerprintContainer").style.display =
              "none";
            document.getElementById("employeeIdInput").value = "";
            document.getElementById("employeeInfoDisplay").style.display =
              "none";
            document.getElementById("attendanceActions").style.display = "none";
            currentEmployee = null;

            alert("All attendance data cleared successfully!");

            // Log analytics
            window.firebaseLogEvent(window.firebaseAnalytics, "data_cleared");
          } catch (error) {
            console.error("Error clearing data:", error);
            alert("Error clearing data: " + error.message);
          }
        }
      }

      // Utility function to format dates
      function formatDate(dateString) {
        try {
          const date = new Date(dateString);
          return date
            .toLocaleDateString("en-GB", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
            })
            .replace(/\//g, "-");
        } catch (error) {
          return dateString;
        }
      }

      window.onload = () => {
        const user = JSON.parse(localStorage.getItem("loggedInUser"));
        if (user) showApp();
        else document.getElementById("loginPage").style.display = "block";
      };

      // Make functions globally available
      window.fetchEmployeeData = fetchEmployeeData;
      window.markAttendance = markAttendance;
      window.fetchAttendanceFromAPI = fetchAttendanceFromAPI;
      window.downloadAttendanceExcel = downloadAttendanceExcel;
      window.showAllAttendance = showAllAttendance;
      window.clearAllData = clearAllData;

      // Authentication check
      if (sessionStorage.getItem("isLoggedIn") !== "true") {
        sessionStorage.setItem("redirectAfterLogin", window.location.pathname);
        window.location.href = "login.html";
      }
    </script>
  </body>
</html>
<script>
                window.addEventListener('message', (event) => {
                  const { data } = event;
                  if (!data?.type) {
                    return;
                  }

                  switch (data.type) {
                    case 'builder.evaluate': {
                      const text = data.data.text;
                      const args = data.data.arguments || [];
                      const id = data.data.id;
                      // tslint:disable-next-line:no-function-constructor-with-string-args
                      const fn = new Function(text);
                      let result;
                      let error = null;
                      try {
                        // eslint-disable-next-line prefer-spread
                        result = fn.apply(null, args);
                      } catch (err) {
                        error = err;
                      }

                      if (error) {
                        window.parent?.postMessage(
                          {
                            type: 'builder.evaluateError',
                            data: { id, error: error.message },
                          },
                          '*'
                        );
                      } else {
                        if (result && typeof result.then === 'function') {
                          result
                            .then((finalResult) => {
                              window.parent?.postMessage(
                                {
                                  type: 'builder.evaluateResult',
                                  data: { id, result: finalResult },
                                },
                                '*'
                              );
                            })
                            .catch(console.error);
                        } else {
                          window.parent?.postMessage(
                            {
                              type: 'builder.evaluateResult',
                              data: { result, id },
                            },
                            '*'
                          );
                        }
                      }
                      break;
                    }
                  }
                });

                window.addEventListener('error', (event) => {
                  window.parent?.postMessage(
                    {
                      type: 'builder.interactiveFrameError',
                      data: { message: event.error?.stack || event.error?.message || event.message },
                    },
                    '*'
                  );
                });
                
                setTimeout(() => {
                  const viteError = document.querySelector('vite-error-overlay')?.shadowRoot?.textContent;
                  if (typeof viteError === 'string') {
                    window.parent?.postMessage(
                      {
                        type: 'builder.interactiveFrameError',
                        data: { message: viteError },
                      },
                      '*'
                    );
                  }
                }, 500);

              </script>